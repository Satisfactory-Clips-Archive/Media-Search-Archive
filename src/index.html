<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Q&A Clips Archive Search</title>
<link rel="shortcut icon" href="./favicon.ico" />
<style>
*
{
	box-sizing: border-box ;
	margin: 0 ;
	padding: 0 ;
	font: inherit ;
	color: inherit ;
	font-size: 1em ;
}

html
{
	font-family: system-ui, sans-serif ;
}

ol, ul
{
	list-style: inside none ;
}

body > section > header,
body > section > header + section,
body > footer,
.results > ol
{
	padding: .5em ;
}

body > section > header,
body > section > header + section,
body > footer,
.results > ol > li
{
	margin: .5em ;
}

.results > ol > li
{
	padding: 1em ;
	border: 1px solid #000 ;
}

h1,
h2,
h3
{
	font-weight: bolder ;
	margin-top: .25em ;
}

h1
{
	font-size: 2em ;
}
h2
{
	font-size: 1.6em ;
}
h3
{
	font-size: 1.2em ;
}

form h1,
form h2,
form h3
{
	font-size: 1em ;
	font-weight: inherit ;
}

aside
{
	white-space: pre-wrap ;
	font-family: monospace ;
}

form
{
	display: flex ;
	flex-wrap: wrap ;
	background: #ccc ;
}

form > *
{
	border: 1px solid ;
	margin: .25em ;
}

form > fieldset
{
	flex-basis: 100% ;
	display: none ;
}

legend[tabindex]
{
	cursor: pointer ;
}

/*
fieldset:not(:focus-within) > legend ~ *
{
	display: none ;
}
*/

[aria-labelledby="date-slider-label"]
{
	display: inline-grid ;
	grid-template-columns: max-content max-content;
	grid-template-rows: max-content ;
	overflow: hidden ;
	position: relative ;
	background: #fff linear-gradient(to bottom, transparent .4em, #aaa .4em, #aaa .8em, transparent .8em) ;
	align-items: center ;
}

[aria-labelledby="date-slider-label"] > h1
{
	display: none ;
}

[aria-labelledby="date-slider-label"] label
{
	position: absolute ;
	clip-path: inset(50%) ;
}

[aria-labelledby="date-slider-label"] input
{
	grid-column: 1 ;
	grid-row: 1 ;
	background: none ;
	pointer-events: none ;
	z-index: 1 ;
}

[aria-labelledby="date-slider-label"] input:focus
{
	z-index: 2 ;
	outline: dotted 1px currentcolor ;
}

[aria-labelledby="date-slider-label"] input,
[aria-labelledby="date-slider-label"] input::-webkit-slider-runnable-track,
[aria-labelledby="date-slider-label"] input::-webkit-slider-thumb
{
	-webkit-appearance: none ;
}

[aria-labelledby="date-slider-label"] input::-webkit-slider-runnable-track
{
	background: none ;
	height: 100% ;
	width: 100% ;
}
[aria-labelledby="date-slider-label"] input::-moz-range-track
{
	background: none ;
	height: 100% ;
	width: 100% ;
}

[aria-labelledby="date-slider-label"] input::-webkit-slider-thumb
{
	background: currentcolor ;
	border: none ;
	border-radius: 0 ;
	pointer-events: auto ;
	width: 1em ;
	height: 1em ;
}
[aria-labelledby="date-slider-label"] input::-moz-range-thumb
{
	background: currentcolor ;
	border: none ;
	border-radius: 0 ;
	pointer-events: auto ;
	width: 1em ;
	height: 1em ;
}

[aria-labelledby="date-slider-label"] output
{
	grid-row: 1 ;
	grid-column: 2 ;
	background: #fff ;
	padding-left: .5em ;
}
</style>
<script src="./lunr.min.js"></script>
<script src="./lunr-highlighter.js"></script>
<link rel="preload" as="fetch" crossorigin="anonymous" href="./lunr.json">
<link rel="preload" as="fetch" crossorigin="anonymous" href="./docs.json">
<link rel="preload" as="fetch" crossorigin="anonymous" href="./synonyms.json">
<link rel="preload" as="fetch" crossorigin="anonymous" href="./topics.json">
<template id="loading">
	<section>
		<header>Loading</header>
		<nav>
			<a
				rel="noopener"
				target="_blank"
				href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory.md"
			>Browse Index</a>
			<a
				rel="noopener"
				target="_blank"
				href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory/topics.md"
			>Browse Topics</a>
		</nav>
		<section>
			<p>Please be patient while the application loads.</p>
		</section>
	</section>
</template>
<template id="ready">
	<section>
		<header>
			<h1>Q&A Clips Archive Search</h1>
			<nav>
				<a
					rel="noopener"
					target="_blank"
					href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory.md"
				>Browse Index</a>
				<a
					rel="noopener"
					target="_blank"
					href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory/topics.md"
				>Browse Topics</a>
			</nav>
			<p>
				<output for="search"></output>
				covering the period
				<output for="date-from date-to">
					<output for="date-from"></output>
					to
					<output for="date-to"
				></output></output>.
			</p>
		</header>
		<section>
			<form>
				<input type="search" id="search" required name="q" title="Search Query">
				<section
					role="group"
					aria-labelledby="date-slider-label"
				>
					<h1 id="date-slider-label">Date Range</h1>
					<label for="date-from">Date From</label>
					<input
						id="date-from"
						name="df"
						type="range"
					>
					<label for="date-to">Date To</label>
					<input
						id="date-to"
						name="dt"
						type="range"
					>
					<output for="date-from date-to">
						<output for="date-from"></output>
						-
						<output for="date-to"></output>
					</output>
				</section>
				<select name="t" title="Topic Filter">
					<option value="" selected>All</option>
				</select>
				<button type="submit" title="Search">ðŸ”Ž</button>
				<fieldset>
					<legend tabindex="0">Search Settings</legend>
						<ul>
							<li>
								<label
									for="min-score"
									title="Minimum Search Score"
								>min. score</label>
								<input
									id="min-score"
									name="ms"
									inputmode="numeric"
									pattern="[0-9]+\.[0-9]+"
									value="0.0"
								>
							</li>
						</ul>
				</fieldset>
			</form>
		</section>
		<section class="results">
		</section>
	</section>
</template>
<template id="document-result">
	<li>
		<section>
			<h1></h1>
			<h2></h2>
			<div></div>
			<h3>Topics</h3>
			<ul></ul>
			<h3>Transcript</h3>
			<aside></aside>
		</section>
		<!--
		<button class="copy" type="button">Copy to Clipboard</button>
		-->
	</li>
</template>
</head>
<body>
<section id="not-ready">
	<header>
		<h1>JavaScript Required</h1>
		<nav>
			<a
				rel="noopener"
				target="_blank"
				href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory.md"
			>Browse Index</a>
			<a
				rel="noopener"
				target="_blank"
				href="https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory/topics.md"
			>Browse Topics</a>
		</nav>
	</header>
	<section>
		<p>JavaScript is required for this application to function.</p>
		<p>If you can still see this notice,
			then the application is either not ready,
			or your browser is not supported.</p>
	</section>
</section>
<footer>
	<h1>Q&A Clips Archive Search</h1>
	<p>&copy; SignpostMarv 2021</p>
	<p>Searchable archive of clips indexed on
		<a
			rel="noopener"
			target="_blank"
			href="https://github.com/SignpostMarv/twitch-clip-notes/"
		>twitch-clip-notes at GitHub</a>.</p>
</footer>
<script async defer>
(async () => {
	if ( ! (URLSearchParams)) {
		throw new Error('Unsupported');
	}

	const ordinals = [
		'th',
		'st',
		'nd',
		'rd',
		'th',
		'th',
		'th',
		'th',
		'th',
		'th',
	];
	const maybe_date_max = [0, 20200901];
	const maybe_date_min = [Infinity, 20200901];
	const date_values = [];
	const date_values_sorted = [];
	const topic_prefix = 'https://github.com/SignpostMarv/twitch-clip-notes/blob/main/coffeestainstudiosdevs/satisfactory/topics/';
	const topic_suffix = '.md';

	let timeout;
	let last_query = '';

	function search (query, on_index) {
		return on_index.search(query).map((result) => {
			return [docs[result.ref], result];
		});
	};

	function perform_search (on_index, modify_state = true) {
		results_container.textContent = '';

		cancelAnimationFrame(timeout);

		timeout = requestAnimationFrame(() => {
			const query = searchbar.value;
			const title = `Q&A Clips Archive Search - ${query}`;

			last_query = query;

			const formdata = new FormData(form);
			const a = date_values_sorted[parseInt(formdata.get('df'), 10)];
			const b = date_values_sorted[parseInt(formdata.get('dt'), 10)];

			formdata.set('df', date_int_to_date(Math.min(a, b)));
			formdata.set('dt', date_int_to_date(Math.max(a, b)));

			const filter_date_from = parseInt(
				formdata.get('df').replace(/\-/g, ''),
				10
			);
			const filter_date_to = parseInt(
				formdata.get('dt').replace(/\-/g, ''),
				10
			);
			const filter_min_score = parseFloat(formdata.get('ms'));
			const filter_topic = formdata.get('t');

			document.head.querySelector('title').textContent = title;

			if (modify_state) {
				history.pushState(
					{},
					title,
					`?q=${
						encodeURIComponent(last_query)
					}&df=${
						encodeURIComponent(formdata.get('df'))
					}&dt=${
						encodeURIComponent(formdata.get('dt'))
					}&ms=${
						encodeURIComponent(formdata.get('ms'))
					}&t=${
						encodeURIComponent(formdata.get('t'))
					}`
				);
			}

			const docs_results = search(
				query.split(' ').map((e) => {
					return e.replace(/\.+$/, '');
				}).join(' '),
				on_index
			).filter((e) => {
				const [doc, result] = e;
				const dateint = parseInt(doc.date.replace(/\-/g, ''), 10);

				return (
					dateint >= filter_date_from
					&& dateint <= filter_date_to
					&& result.score >= filter_min_score
					&& (
						'' === filter_topic
						|| doc.topics.includes(filter_topic)
					)
				);
			});

			result_count.textContent = `${
					docs_results.length
				} results found matching the term "${
					query
				}", under ${
					'' === filter_topic
						? ' all topics'
						: (
							' the "'
							+ (topics[filter_topic] || ['unknown']).join(' > ')
							+ '" topic '
						)
				}`;
			date_from_output_update(true);
			date_to_output_update(true);

			if (docs_results.length > 0) {
				const frag = document.createElement('ol');

				docs_results.map((e) => {
					const [doc, result] = e;
					const node = search_result_template.cloneNode(true);
					const doc_date = new Date(doc.date);

					node.querySelector('h1').textContent = (
						date_format(doc_date)
						+ ' Livestream'
					);
					node.querySelector('h2').textContent = doc.title;

					if (doc.urls.length > 1) {
						var urls_dest = document.createElement('ol');

						doc.urls.map((url, i) => {
							const anchor = document.createElement('a');
							const part = document.createElement('li');

							anchor.rel = 'noopener';
							anchor.target = '_blank';
							anchor.textContent = url;
							anchor.href = url;

							part.textContent = `Part ${i + 1}: `;
							part.appendChild(anchor);

							return part;
						}).forEach((subnode) => {
							urls_dest.appendChild(subnode);
						});
					} else {
						var urls_dest = document.createElement('p');
						const anchor = document.createElement('a');

						anchor.rel = 'noopener';
						anchor.target = '_blank';
						anchor.textContent = doc.urls[0];
						anchor.href = doc.urls[0];

						urls_dest.appendChild(anchor);
					}

					doc.topics.map((topic) => {
						const subnode = document.createElement('li');
						const anchor = document.createElement('a');

						anchor.rel = 'noopener';
						anchor.target = 'blank';
						anchor.textContent = topic;
						anchor.href = `${topic_prefix}${topic}${topic_suffix}`;

						subnode.appendChild(anchor);

						return subnode
					}).forEach((subnode) => {
						node.querySelector('ul').appendChild(subnode);
					});

					node.querySelector('section').replaceChild(urls_dest, node.querySelector('div'));

					const transcription = node.querySelector('aside');
					transcription.textContent = doc.transcription;

					const positions = [];

					Object.keys(result.matchData.metadata).forEach((term) => {
						positions.push(...(
								result.matchData.metadata[term].transcription
								|| {position:[]}
							).position
						);
					});
					lunrhighlighter(
						transcription,
						positions
					);

					return node;
				}).forEach((node) => {
					frag.appendChild(node);
				});

				results_container.appendChild(frag);
			}
		});
	};

	function hashsearch(on_index, modify_state = true) {
		const params = new URLSearchParams(location.search);

		if (params.has('q')) {
			searchbar.value = params.get('q');

			if (params.has('df')) {
				date_from_value_by_date(params.get('df'));
			} else {
				date_from_value_by_index(date_from.min);
			}

			if (params.has('dt')) {
				date_to_value_by_date(params.get('dt'));
			} else {
				date_to_value_by_index(date_to.min);
			}

			if (params.has('ms')) {
				score_filter.value = params.get('ms');
			} else {
				score_filter.value = '0.0';
			}

			if (params.has('t')) {
				const maybe_topic = topic_filter.querySelector(
					`[value="${params.get('t')}"]`
				);

				if (maybe_topic) {
					maybe_topic.selected = true;
				} else {
					topic_filter.querySelector('[value=""]').selected = true;
				}
			} else {
				topic_filter.querySelector('[value=""]').selected = true;
			}

			date_from_output_update();
			date_to_output_update();
			perform_search(on_index, modify_state);
		}
	}

	function aliasSatisfactoryVocabulary (token) {
		const lowercase = token.toString().toLowerCase();

		if (synonym_keys.includes(synonyms)) {
			return token.update(() => {
				return synonyms[lowercase];
			});
		}

		return token;
	}

	function date_int_to_date(int) {
		const parts = /^(\d+)(\d{2})(\d{2})$/.exec(int.toString(10));

		return `${parts[1]}-${parts[2]}-${parts[3]}`;
	}

	//#region template & output

	const not_ready = document.getElementById('not-ready');
	const loading = document.getElementById('loading').content.cloneNode(
		true
	);
	const search_result_template = document.getElementById(
		'document-result'
	).content;

	//#region page ready

	const ready = document.getElementById('ready').content.cloneNode(
		true
	);

	const searchbar = ready.querySelector('input[type="search"]');
	const results_container = ready.querySelector('.results');
	const result_count = ready.querySelector('header output[for="search"]');

	//#region form

	const form = ready.querySelector('form');
	const date_from = form.querySelector('#date-from');
	const date_to = form.querySelector('#date-to');
	const score_filter = form.querySelector('#min-score');
	const topic_filter = form.querySelector('[name="t"]');
	const date_output = form.querySelector('output[for="date-from date-to"]');
	const date_from_output = date_output.querySelector('[for="date-from"]');
	const date_to_output = date_output.querySelector('[for="date-to"]');
	const readable_date_output = ready.querySelector('output[for="date-from date-to"]');
	const readable_date_from_output = readable_date_output.querySelector('[for="date-from"]');
	const readable_date_to_output = readable_date_output.querySelector('[for="date-to"]');
	const date_from_output_update = (update_readable = false) => {
		let value = date_values_sorted[date_from.value] || 'n/a';

		if (Number.isInteger(value)) {
			value = date_int_to_date(value);
		}

		date_from_output.textContent = value;

		if (update_readable) {
			readable_date_from_output.textContent = date_format(new Date(value));
		}
	};
	const date_to_output_update = (update_readable = false) => {
		let value = date_values_sorted[date_to.value] || 'n/a';

		if (Number.isInteger(value)) {
			value = date_int_to_date(value);
		}

		date_to_output.textContent = value;

		if (update_readable) {
			readable_date_to_output.textContent = date_format(new Date(value));
		}
	};

	date_from.addEventListener('change', () => {date_from_output_update(); });
	date_to.addEventListener('change', () => {date_to_output_update(); });
	date_from.addEventListener('input', () => {date_from_output_update(); });
	date_to.addEventListener('input', () => {date_to_output_update(); });

	function date_from_value_by_index(index) {
		date_from.value = index;
		date_from_output_update();
	}

	function date_from_value_by_date(date) {
		date_from_value_by_index(
			date_values_sorted.indexOf(
				parseInt(date.replace(/\-/g, ''), 10)
			)
		);
	}

	function date_to_value_by_index(index) {
		date_to.value = index;
		date_to_output_update();
	}

	function date_to_value_by_date(date) {
		date_to_value_by_index(
			date_values_sorted.indexOf(
				parseInt(date.replace(/\-/g, ''), 10)
			)
		);
	}

	function date_format (date) {
		return (
			date.getDate() +
			ordinals[date.getDate() % 10] +
			' ' +
			date.toLocaleDateString(
			'en-GB',
				{ year: 'numeric', month: 'long'}
			)
		);
	}

	//#endregion

	//#endregion

	//#endregion

	//#region fetches

	const fetch_prebuilt_index = fetch('./lunr.json');
	const fetch_docs = fetch('./docs.json');
	const fetch_synonyms = fetch('./synonyms.json');
	const fetch_topics = fetch('./topics.json');

	const [
		prebuilt_index,
		docs,
		synonyms,
		topics,
	] = await Promise.all((await Promise.all([
		fetch_prebuilt_index,
		fetch_docs,
		fetch_synonyms,
		fetch_topics,
	])).map((e) => e.json()));

	const synonym_keys = Object.keys(synonyms);

	//#endregion

	not_ready.parentNode.replaceChild(loading, not_ready);

	lunr.Pipeline.registerFunction(
		aliasSatisfactoryVocabulary,
		'aliasSatisfactoryVocabulary'
	);

	const index = lunr.Index.load(prebuilt_index);

	//#region date min/max

	for (const doc_entry of Object.entries(docs)) {
		const [, doc] = doc_entry;
		const maybe = parseInt(doc.date.replace(/\-/g, ''), 10);

		if ( ! maybe_date_max.includes(maybe)) {
			maybe_date_max.push(maybe);
			maybe_date_min.push(maybe);
			date_values.push(maybe);
		}
	}

	const date_max = (
		Math.max(...maybe_date_max).toString(10)
	);
	const date_min = (
		Math.min(...maybe_date_min).toString(10)
	);
	date_values.sort().forEach((e) => {
		date_values_sorted.push(e);
	});

	date_from.value = date_from.min = date_to.min = 0;
	date_to.value = date_from.max = date_to.max = (date_values.length - 1);
	date_from_output_update();
	date_to_output_update();

	//#endregion

	const topic_filter_frag = document.createDocumentFragment();

	Object.entries(topics).forEach((e) => {
		const [slug, unslugged] = e;
		const option = document.createElement('option');

		option.value = slug;
		option.textContent = unslugged.join(' > ');

		topic_filter_frag.appendChild(option);
	});

	topic_filter.appendChild(topic_filter_frag);

	form.addEventListener('submit', (e) => {
		e.preventDefault();
		if (searchbar.checkValidity()) {
			perform_search(index);
		}
	});

	window.onpopstate = () => {
		hashsearch(index, false);
	};
	hashsearch(index, false);

	document.body.firstElementChild.parentNode.replaceChild(
		ready,
		document.body.firstElementChild
	);

	/**
	document.body.addEventListener(
		'click',
		(e) => {
			console.log('foo');
			if ((e.target instanceof HTMLButtonElement) && e.target.classList.contains('copy')) {
				navigator.clipboard.writeText(e.target.parentNode.querySelector('section').textContent);
			}
		},
		{
			capture: true,
			passive: true,
		}
	);
	*/
})();
</script>
</body>
</html>
